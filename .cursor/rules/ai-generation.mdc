---
description: Правила для AI-генерации — fal.ai, ComfyUI, LoRA, промпты, Kling видео
globs: **/services/ai/**, **/worker/**
alwaysApply: false
---

# AI Generation Rules — Sellora AI

## Провайдеры и приоритет
1. **Изображения**: Flux.1.1 Pro (дешевле) → Flux.1.1 Ultra (качество) через fal.ai
2. **Консистентность (цифровой двойник)**: ComfyUI на RunPod + IP-Adapter + ControlNet + авто-LoRA
3. **Видео**: Kling 3.0 через fal.ai — только для премиум-пакетов
4. **LLM усилитель промптов**: Claude 4 Sonnet (основной) / Groq Llama-4 (быстрый/дешёвый)

## Промпт-пайплайн
```
Русский ввод пользователя
  → LLM усилитель (Claude/Groq) → маркетинговый English промпт
  → Flux.1.1 / ComfyUI
  → Пост-обработка (RemBG, 4K upscale, watermark, resize для WB)
  → Готовое фото
```

## Цифровой двойник (авто-LoRA)
- Пользователь загружает 3–5 фото товара
- Запускаем LoRA-обучение на RunPod (A6000, ~3–5 мин)
- Сохраняем LoRA веса в Supabase Storage
- При генерации: применяем LoRA + IP-Adapter для консистентности

## One-Click Full Card Kit
Генерировать всегда в одной задаче (Celery group):
- Слайд 1: главное фото товара
- Слайды 2–4: разные ракурсы / сцены
- Слайды 5–7: инфографика (характеристики, стрелки)
- Слайд 8: lifestyle сцена
- Слайд 9: упаковка / детали

## Себестоимость — держать в уме
| Тип | Провайдер | Стоимость |
|-----|-----------|-----------|
| Фото Flux Pro | fal.ai | ~2.3–3 ₽ |
| Фото Flux Ultra | fal.ai | ~4–4.6 ₽ |
| Видео 10 сек Kling | fal.ai | ~54–77 ₽ |
| LoRA обучение | RunPod A6000 | ~38 ₽ (5 мин) |

Маржа на фото должна быть минимум 75% — не занижать тарифы.

## Пост-обработка (обязательно)
- Удаление фона: `rembg` библиотека
- Upscale до 4K: Real-ESRGAN через fal.ai
- Resize под WB (900×1200px, max 5MB)
- Watermark: только если пользователь на бесплатном тарифе
